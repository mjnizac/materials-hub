# ----------------------------------------------------------------------------
# Publish image in Docker Hub Workflow
# This workflow builds and pushes a Docker image to Docker Hub whenever
# a new release is published on GitHub.
# ----------------------------------------------------------------------------

name: Publish image in Docker Hub

on:
  pull_request:
    branches:
      - main
  release:
    # Trigger only when a release is published
    types: [published]

jobs:
  #push_to_registry:
  build-and-push:
    runs-on: ubuntu-24.04

    steps:
      
      # Step 1: Check out the repository code
      - name: Check out the repo
      - uses: actions/checkout@v5

      # 2. Calcular TAG e IMAGE segÃºn el tipo de evento
      - name: Set image metadata
        id: meta
        run: |
          IMAGE=${{ secrets.DOCKER_USER }}/uvlhub

          if [ "${{ github.event_name }}" = "release" ]; then
            TAG=${{ github.event.release.tag_name }}
            PUSH=true
          else
            TAG=pr-${{ github.event.number }}
            PUSH=false
          fi

          echo "IMAGE=$IMAGE" >> $GITHUB_OUTPUT
          echo "TAG=$TAG" >> $GITHUB_OUTPUT
          echo "PUSH=$PUSH" >> $GITHUB_OUTPUT

      # 3. Login en Docker Hub SOLO si es un release
      - name: Log in to Docker Hub
        if: steps.meta.outputs.PUSH == 'true'
        uses: docker/login-action@v3.6.0
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 4. Build de la imagen (siempre, en PR y en release)
      - name: Build Docker image
        env:
          IMAGE: ${{ steps.meta.outputs.IMAGE }}
          TAG: ${{ steps.meta.outputs.TAG }}
        run: |
          echo "Building image: $IMAGE:$TAG"
          docker build \
            --build-arg VERSION_TAG=$TAG \
            -t $IMAGE:$TAG \
            -f docker/images/Dockerfile.prod .

      # 5. Push de la imagen SOLO en release
      - name: Push Docker image (release tag)
        if: steps.meta.outputs.PUSH == 'true'
        env:
          IMAGE: ${{ steps.meta.outputs.IMAGE }}
          TAG: ${{ steps.meta.outputs.TAG }}
        run: |
          echo "Pushing image: $IMAGE:$TAG"
          docker push $IMAGE:$TAG

      # 6. Tag y push de latest SOLO en release
      - name: Tag and push latest
        if: steps.meta.outputs.PUSH == 'true'
        env:
          IMAGE: ${{ steps.meta.outputs.IMAGE }}
          TAG: ${{ steps.meta.outputs.TAG }}
        run: |
          echo "Tagging $IMAGE:$TAG as $IMAGE:latest"
          docker tag $IMAGE:$TAG $IMAGE:latest
          docker push $IMAGE:latest