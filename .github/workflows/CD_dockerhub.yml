# ----------------------------------------------------------------------------
# Publish image in Docker Hub Workflow
# This workflow builds and pushes a Docker image to Docker Hub after a successful release.
# Runs in parallel with Deploy to Render.
# ----------------------------------------------------------------------------

name: Publish to Docker Hub

on:
  workflow_run:
    workflows:
      - "Auto Release"
    types:
      - completed
    branches:
      - main

# Solo un build/push a la vez
concurrency:
  group: dockerhub-publish-main
  cancel-in-progress: false

jobs:
  build-and-push:
    runs-on: ubuntu-24.04
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      # 1. Check out del repositorio
      - name: Check out the repo
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Necesario para obtener tags

      # 2. Obtener el Ãºltimo tag de versiÃ³n creado por el release
      - name: Get latest version tag
        id: get-tag
        run: |
          # Obtener el Ãºltimo tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Tag encontrado: $LATEST_TAG"
          echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "version=${LATEST_TAG#v}" >> $GITHUB_OUTPUT

      # 3. Configurar metadata de la imagen
      - name: Set image metadata
        id: meta
        run: |
          IMAGE=${{ secrets.DOCKER_USER }}/uvlhub
          TAG=${{ steps.get-tag.outputs.tag }}
          VERSION=${{ steps.get-tag.outputs.version }}

          echo "Building Docker image:"
          echo "  Image: $IMAGE"
          echo "  Tag: $TAG"
          echo "  Version: $VERSION"

          echo "IMAGE=$IMAGE" >> $GITHUB_OUTPUT
          echo "TAG=$TAG" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      # 4. Login en Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v3.6.0
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 5. Build de la imagen con mÃºltiples tags
      - name: Build Docker image
        env:
          IMAGE: ${{ steps.meta.outputs.IMAGE }}
          TAG: ${{ steps.meta.outputs.TAG }}
          VERSION: ${{ steps.meta.outputs.VERSION }}
        run: |
          echo "ðŸ³ Building Docker image..."
          echo "  Image: $IMAGE"
          echo "  Tags: $TAG, $VERSION, latest"

          docker build \
            --build-arg VERSION_TAG=$VERSION \
            -t $IMAGE:$TAG \
            -t $IMAGE:$VERSION \
            -t $IMAGE:latest \
            -f docker/images/Dockerfile.prod .

          echo "âœ… Image built successfully"

      # 6. Push de todas las variantes del tag
      - name: Push Docker images
        env:
          IMAGE: ${{ steps.meta.outputs.IMAGE }}
          TAG: ${{ steps.meta.outputs.TAG }}
          VERSION: ${{ steps.meta.outputs.VERSION }}
        run: |
          echo "ðŸ“¤ Pushing images to Docker Hub..."
          docker push $IMAGE:$TAG
          docker push $IMAGE:$VERSION
          docker push $IMAGE:latest
          echo "âœ… All images pushed successfully"

      # 7. Resumen
      - name: Summary
        env:
          IMAGE: ${{ steps.meta.outputs.IMAGE }}
          TAG: ${{ steps.meta.outputs.TAG }}
        run: |
          echo "## ðŸ³ Docker Image Published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`$IMAGE\`" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`$TAG\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ steps.meta.outputs.VERSION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Docker Hub" >> $GITHUB_STEP_SUMMARY
          echo "[View on Docker Hub](https://hub.docker.com/r/$IMAGE)" >> $GITHUB_STEP_SUMMARY
