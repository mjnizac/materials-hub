# ----------------------------------------------------------------------------
# Auto Release Workflow
# This workflow automatically creates a new release when all CI checks pass on main.
# It generates a version tag, creates a GitHub release with changelog, and publishes artifacts.
# ----------------------------------------------------------------------------

name: Auto Release

on:
  workflow_run:
    workflows: ["Pytest", "Python Lint", "Run Application", "Performance Tests", "E2E Tests"]
    types:
      - completed
    branches:
      - main

jobs:
  check-and-release:
    runs-on: ubuntu-24.04
    # Only run if all required workflows succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:

      # Step 1: Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: main

      # Step 2: Wait for all workflows to complete
      - name: Wait for all workflows
        uses: actions/github-script@v7
        id: check-workflows
        with:
          script: |
            const sha = '${{ github.event.workflow_run.head_sha }}';
            console.log(`Checking workflows for commit: ${sha}`);

            // Wait for workflows to register
            await new Promise(resolve => setTimeout(resolve, 15000));

            const requiredWorkflows = ['Pytest', 'Python Lint', 'Run Application', 'Performance Tests', 'E2E Tests'];

            const { data: checkRuns } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: sha
            });

            console.log(`Found ${checkRuns.check_runs.length} check runs`);

            const relevantChecks = checkRuns.check_runs.filter(check =>
              requiredWorkflows.some(workflow => check.name.includes(workflow))
            );

            console.log('Workflow status:');
            relevantChecks.forEach(check => {
              console.log(`  - ${check.name}: ${check.conclusion}`);
            });

            const allPassed = relevantChecks.every(check =>
              check.conclusion === 'success'
            );

            if (!allPassed) {
              core.setFailed('Not all required workflows passed');
              return false;
            }

            console.log('âœ… All workflows passed! Ready to create release.');
            return true;

      # Step 3: Get current version from pyproject.toml
      - name: Get current version
        id: get-version
        run: |
          VERSION=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          echo "current_version=$VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $VERSION"

      # Step 4: Check if tag already exists
      - name: Check if tag exists
        id: check-tag
        run: |
          VERSION="${{ steps.get-version.outputs.current_version }}"
          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "tag_exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Tag v$VERSION already exists. Skipping release."
          else
            echo "tag_exists=false" >> $GITHUB_OUTPUT
            echo "âœ… Tag v$VERSION does not exist. Proceeding with release."
          fi

      # Step 5: Generate changelog
      - name: Generate Changelog
        id: changelog
        if: steps.check-tag.outputs.tag_exists == 'false'
        run: |
          VERSION="${{ steps.get-version.outputs.current_version }}"

          # Get the last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            echo "First release - generating changelog from all commits"
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            echo "Generating changelog from $LAST_TAG to HEAD"
            COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi

          # Create changelog file
          cat > RELEASE_NOTES.md << EOF
          # Release v${VERSION}

          ## What's Changed

          ${COMMITS}

          ## CI Status

          All automated checks passed:
          - âœ… Python Lint
          - âœ… Pytest (Unit + Integration)
          - âœ… Run Application
          - âœ… Performance Tests
          - âœ… E2E Tests

          **Full Changelog**: https://github.com/${{ github.repository }}/compare/${LAST_TAG}...v${VERSION}
          EOF

          echo "Changelog generated!"
          cat RELEASE_NOTES.md

      # Step 6: Create Git tag
      - name: Create tag
        if: steps.check-tag.outputs.tag_exists == 'false'
        run: |
          VERSION="${{ steps.get-version.outputs.current_version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v$VERSION" -m "Release v$VERSION"
          git push origin "v$VERSION"
          echo "âœ… Tag v$VERSION created and pushed"

      # Step 7: Create GitHub Release
      - name: Create GitHub Release
        if: steps.check-tag.outputs.tag_exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.get-version.outputs.current_version }}
          name: Release v${{ steps.get-version.outputs.current_version }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Step 8: Generate release summary
      - name: Release Summary
        if: steps.check-tag.outputs.tag_exists == 'false'
        run: |
          VERSION="${{ steps.get-version.outputs.current_version }}"
          echo "## ðŸš€ Release Created!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.event.workflow_run.head_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Release Assets" >> $GITHUB_STEP_SUMMARY
          echo "- [View Release](https://github.com/${{ github.repository }}/releases/tag/v$VERSION)" >> $GITHUB_STEP_SUMMARY
          echo "- [Download Source Code](https://github.com/${{ github.repository }}/archive/refs/tags/v$VERSION.zip)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Update version in pyproject.toml for next release" >> $GITHUB_STEP_SUMMARY
          echo "2. Continue development on develop branch" >> $GITHUB_STEP_SUMMARY

      # Step 9: Notify if skipped
      - name: Skipped Summary
        if: steps.check-tag.outputs.tag_exists == 'true'
        run: |
          VERSION="${{ steps.get-version.outputs.current_version }}"
          echo "## âš ï¸ Release Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Tag v$VERSION already exists." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To create a new release:" >> $GITHUB_STEP_SUMMARY
          echo "1. Update version in pyproject.toml" >> $GITHUB_STEP_SUMMARY
          echo "2. Commit and push to main" >> $GITHUB_STEP_SUMMARY
