# ----------------------------------------------------------------------------
# Auto Release Workflow
# This workflow automatically creates a new release when all CI checks pass on main.
# Uses Semantic Versioning based on conventional commits (feat, fix, BREAKING CHANGE).
# ----------------------------------------------------------------------------

name: Auto Release

on:
  workflow_run:
    workflows:
      - "All Tests Passed"
    types:
      - completed
    branches:
      - main

# Prevenir mÃºltiples releases al mismo tiempo
concurrency:
  group: release-${{ github.sha }}
  cancel-in-progress: true

jobs:
  semantic-release:
    runs-on: ubuntu-24.04
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:

      # Step 1: Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Necesitamos todo el historial para semantic versioning
          ref: main

      # Step 2: Analizar commits y determinar nueva versiÃ³n
      - name: Determinar nueva versiÃ³n
        id: semver
        run: |
          # Obtener el Ãºltimo tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Ãšltimo tag: $LAST_TAG"

          # Obtener versiÃ³n actual sin 'v'
          CURRENT_VERSION=${LAST_TAG#v}
          echo "VersiÃ³n actual: $CURRENT_VERSION"

          # Parsear versiÃ³n (MAJOR.MINOR.PATCH)
          MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
          MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)
          PATCH=$(echo $CURRENT_VERSION | cut -d. -f3)

          # Analizar commits desde el Ãºltimo tag
          COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"%s" 2>/dev/null || git log --pretty=format:"%s")

          # Determinar tipo de bump basado en conventional commits
          BUMP="none"

          if echo "$COMMITS" | grep -iq "BREAKING CHANGE"; then
            BUMP="major"
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
          elif echo "$COMMITS" | grep -Eq "^(feat|feature|âœ¨)"; then
            BUMP="minor"
            MINOR=$((MINOR + 1))
            PATCH=0
          elif echo "$COMMITS" | grep -Eq "^(fix|ðŸ›|bugfix)"; then
            BUMP="patch"
            PATCH=$((PATCH + 1))
          fi

          NEW_VERSION="$MAJOR.$MINOR.$PATCH"

          echo "Tipo de bump: $BUMP"
          echo "Nueva versiÃ³n: $NEW_VERSION"

          echo "bump=$BUMP" >> $GITHUB_OUTPUT
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "last_tag=$LAST_TAG" >> $GITHUB_OUTPUT

      # Step 3: Salir si no hay cambios significativos
      - name: Verificar si hay cambios
        if: steps.semver.outputs.bump == 'none'
        run: |
          echo "â­ï¸  No hay cambios significativos (feat/fix/BREAKING). Saltando release."
          exit 0

      # Step 4: Actualizar pyproject.toml con nueva versiÃ³n
      - name: Actualizar pyproject.toml
        if: steps.semver.outputs.bump != 'none'
        run: |
          NEW_VERSION="${{ steps.semver.outputs.new_version }}"
          sed -i "s/^version = .*/version = \"$NEW_VERSION\"/" pyproject.toml
          echo "âœ… pyproject.toml actualizado a v$NEW_VERSION"

      # Step 5: Generar changelog
      - name: Generar Changelog
        id: changelog
        if: steps.semver.outputs.bump != 'none'
        run: |
          NEW_VERSION="${{ steps.semver.outputs.new_version }}"
          LAST_TAG="${{ steps.semver.outputs.last_tag }}"

          # Generar changelog agrupado por tipo
          echo "# Release v${NEW_VERSION}" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## ðŸ“ Cambios" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md

          # Features
          FEATURES=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges | grep -v "\[skip ci\]" | grep -E "^- (feat|feature|âœ¨)" || echo "")
          if [ ! -z "$FEATURES" ]; then
            echo "### âœ¨ Nuevas Funcionalidades" >> RELEASE_NOTES.md
            echo "$FEATURES" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
          fi

          # Fixes
          FIXES=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges | grep -v "\[skip ci\]" | grep -E "^- (fix|ðŸ›|bugfix)" || echo "")
          if [ ! -z "$FIXES" ]; then
            echo "### ðŸ› Correcciones" >> RELEASE_NOTES.md
            echo "$FIXES" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
          fi

          # Other changes (excluding [skip ci] commits)
          OTHER=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges | grep -v "\[skip ci\]" | grep -vE "^- (feat|feature|âœ¨|fix|ðŸ›|bugfix)" || echo "")
          if [ ! -z "$OTHER" ]; then
            echo "### ðŸ”§ Otros Cambios" >> RELEASE_NOTES.md
            echo "$OTHER" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
          fi

          echo "## âœ… CI Status" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "Todos los tests pasaron exitosamente:" >> RELEASE_NOTES.md
          echo "- âœ… Tests Unitarios" >> RELEASE_NOTES.md
          echo "- âœ… Tests de IntegraciÃ³n" >> RELEASE_NOTES.md
          echo "- âœ… Tests de Interfaz" >> RELEASE_NOTES.md
          echo "- âœ… Tests de Carga" >> RELEASE_NOTES.md
          echo "- âœ… Python Lint" >> RELEASE_NOTES.md
          echo "- âœ… Run Application" >> RELEASE_NOTES.md
          echo "- âœ… Commits Syntax Checker" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "**Changelog Completo**: https://github.com/${{ github.repository }}/compare/${LAST_TAG}...v${NEW_VERSION}" >> RELEASE_NOTES.md

          echo "ðŸ“„ Changelog generado"
          cat RELEASE_NOTES.md

      # Step 6: Commit y push de pyproject.toml actualizado
      - name: Commit nueva versiÃ³n
        if: steps.semver.outputs.bump != 'none'
        run: |
          NEW_VERSION="${{ steps.semver.outputs.new_version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pyproject.toml
          git commit -m "chore(release): bump version to v${NEW_VERSION} [skip ci]"
          git push origin main
          echo "âœ… VersiÃ³n commitada"

      # Step 7: Crear Git tag
      - name: Crear tag
        if: steps.semver.outputs.bump != 'none'
        run: |
          NEW_VERSION="${{ steps.semver.outputs.new_version }}"
          git tag -a "v$NEW_VERSION" -m "Release v$NEW_VERSION"
          git push origin "v$NEW_VERSION"
          echo "âœ… Tag v$NEW_VERSION creado y pusheado"

      # Step 8: Crear GitHub Release
      - name: Crear GitHub Release
        if: steps.semver.outputs.bump != 'none'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.semver.outputs.new_version }}
          name: Release v${{ steps.semver.outputs.new_version }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Step 9: Resumen
      - name: Resumen del Release
        if: steps.semver.outputs.bump != 'none'
        run: |
          NEW_VERSION="${{ steps.semver.outputs.new_version }}"
          BUMP="${{ steps.semver.outputs.bump }}"
          echo "## ðŸš€ Release Creado!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**VersiÃ³n:** v$NEW_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**Tipo:** $BUMP" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Enlaces" >> $GITHUB_STEP_SUMMARY
          echo "- [Ver Release](https://github.com/${{ github.repository }}/releases/tag/v$NEW_VERSION)" >> $GITHUB_STEP_SUMMARY
          echo "- [Descargar CÃ³digo](https://github.com/${{ github.repository }}/archive/refs/tags/v$NEW_VERSION.zip)" >> $GITHUB_STEP_SUMMARY
