# ----------------------------------------------------------------------------
# Commits Syntax Checker Workflow
# This workflow validates commit messages against the Conventional Commits specification.
# It runs only on pushes to main and develop branches.
# ----------------------------------------------------------------------------

name: Commits Syntax Checker

on:
  # Trigger the workflow only on push to main and develop branches
  push:
    branches: [main, develop]

jobs:
  check:
    name: Conventional Commits
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Validate commit messages with detailed feedback
        run: |
          echo "## ðŸ“ Validando mensajes de commits" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Tipos permitidos
          ALLOWED_TYPES="^(feat|fix|docs)(\(.+\))?!?: .+"

          # Obtener commits del push
          if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            # Primer push a la rama
            COMMITS=$(git log --format="%H|%s" -n 10)
          else
            COMMITS=$(git log --format="%H|%s" ${{ github.event.before }}..${{ github.event.after }})
          fi

          INVALID_COMMITS=""
          VALID_COUNT=0
          INVALID_COUNT=0

          echo "### Commits analizados:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          while IFS='|' read -r hash message; do
            # Ignorar commits automÃ¡ticos
            if echo "$message" | grep -q "\[skip ci\]"; then
              echo "â­ï¸  \`${hash:0:7}\` - $message (skip ci)" >> $GITHUB_STEP_SUMMARY
              continue
            fi

            # Ignorar commits con emojis al inicio (commits antiguos ya validados)
            if echo "$message" | grep -Eq "^[[:space:]]*(âœ¨|ðŸ›|ðŸ“|ðŸ”§|â™»ï¸|ðŸŽ¨|âš¡|ðŸ”¥|âœ…|ðŸš€)"; then
              echo "â­ï¸  \`${hash:0:7}\` - $message (legacy commit)" >> $GITHUB_STEP_SUMMARY
              continue
            fi

            # Ignorar commits tipo "chore:" anteriores (legacy)
            if echo "$message" | grep -Eq "^chore:"; then
              echo "â­ï¸  \`${hash:0:7}\` - $message (legacy commit)" >> $GITHUB_STEP_SUMMARY
              continue
            fi

            if echo "$message" | grep -Eq "$ALLOWED_TYPES"; then
              echo "âœ… \`${hash:0:7}\` - $message" >> $GITHUB_STEP_SUMMARY
              VALID_COUNT=$((VALID_COUNT + 1))
            else
              echo "âŒ \`${hash:0:7}\` - **$message**" >> $GITHUB_STEP_SUMMARY
              INVALID_COMMITS="$INVALID_COMMITS\n  - [$hash] $message"
              INVALID_COUNT=$((INVALID_COUNT + 1))
            fi
          done <<< "$COMMITS"

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Resumen:** âœ… $VALID_COUNT vÃ¡lido(s) | âŒ $INVALID_COUNT invÃ¡lido(s)" >> $GITHUB_STEP_SUMMARY

          if [ $INVALID_COUNT -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âŒ Formato Incorrecto Detectado" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Los siguientes commits NO siguen el formato Conventional Commits:" >> $GITHUB_STEP_SUMMARY
            echo "$INVALID_COMMITS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“‹ Formato Correcto" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Usa uno de estos formatos:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "feat: aÃ±adir nueva funcionalidad" >> $GITHUB_STEP_SUMMARY
            echo "fix: corregir bug en login" >> $GITHUB_STEP_SUMMARY
            echo "docs: actualizar documentaciÃ³n" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Con scope opcional:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "feat(auth): aÃ±adir OAuth2" >> $GITHUB_STEP_SUMMARY
            echo "fix(api): corregir endpoint" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY

            echo "âŒ Commits con formato incorrecto detectados"
            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Todos los commits siguen el formato correcto" >> $GITHUB_STEP_SUMMARY
