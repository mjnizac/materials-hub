name: Deploy to Render

on:
  workflow_run:
    workflows:
      - "Auto Release"
    types:
      - completed
    branches:
      - main

# Solo un deploy a la vez
concurrency:
  group: deploy-render-main
  cancel-in-progress: false

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Get release version
        id: version
        run: |
          VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Desplegando versiÃ³n: $VERSION"

      - name: Deploy a Render
        run: |
          echo "âœ… Release ${{ steps.version.outputs.version }} creado exitosamente"
          echo "ðŸš€ Desplegando a Render..."
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}"
          echo "âœ… Deploy webhook enviado"

      - name: Summary
        run: |
          echo "## ðŸš€ Deploy to Render" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**VersiÃ³n:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Webhook enviado exitosamente" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "El deploy se completarÃ¡ en unos minutos en Render." >> $GITHUB_STEP_SUMMARY

