# ----------------------------------------------------------------------------
# Workflow Checkpoint - All Tests Passed
# Este workflow revisa peri√≥dicamente si todos los workflows de CI han pasado.
# Act√∫a como checkpoint antes del deploy a Render.
# Se ejecuta cada 5 minutos para evitar disparos m√∫ltiples.
# ----------------------------------------------------------------------------

name: All Tests Passed

on:
  schedule:
    - cron: '*/5 * * * *'  # Cada 5 minutos
  workflow_dispatch:  # Permitir ejecuci√≥n manual

# Solo una ejecuci√≥n a la vez
concurrency:
  group: all-tests-passed-main
  cancel-in-progress: false

jobs:
  check-all-passed:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          ref: main
          fetch-depth: 10  # √öltimos 10 commits

      - name: Verificar √∫ltimo commit y workflows
        uses: actions/github-script@v7
        with:
          script: |
            const workflows = [
              'Tests Unitarios',
              'Tests de Integraci√≥n',
              'Tests de Interfaz',
              'Tests de Carga',
              'Python Lint',
              'Run Application',
              'Commits Syntax Checker'
            ];

            // Obtener el √∫ltimo commit de main
            const { data: mainBranch } = await github.rest.repos.getBranch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              branch: 'main'
            });
            const latestSha = mainBranch.commit.sha;

            console.log(`üìã Revisando workflows para commit: ${latestSha}`);

            // Verificar si "Auto Release" ya se ejecut√≥ para este commit
            // (lo cual significa que ya pasamos por aqu√≠)
            const { data: releaseRuns } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'CD_release.yml',
              per_page: 5
            });

            const alreadyProcessed = releaseRuns.workflow_runs.some(
              run => run.head_sha === latestSha && run.status === 'completed'
            );

            if (alreadyProcessed) {
              console.log('‚úÖ Este commit ya fue procesado (Auto Release completado)');
              console.log('No es necesario hacer nada');
              return;
            }

            // Obtener todos los workflow runs para este commit
            const { data: workflowRuns } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event: 'push',
              branch: 'main',
              per_page: 100
            });

            // Filtrar runs del commit actual
            const runsForCommit = workflowRuns.workflow_runs.filter(
              run => run.head_sha === latestSha
            );

            console.log(`\nEncontrados ${runsForCommit.length} workflow runs para este commit`);

            // Verificar estado de cada workflow requerido
            const workflowStatus = {};
            let allCompleted = true;
            let anyFailed = false;

            for (const workflowName of workflows) {
              const run = runsForCommit.find(r => r.name === workflowName);

              if (!run) {
                console.log(`‚è≥ Workflow '${workflowName}' - No encontrado (a√∫n no empez√≥)`);
                workflowStatus[workflowName] = 'not_started';
                allCompleted = false;
              } else if (run.status !== 'completed') {
                console.log(`‚è≥ Workflow '${workflowName}' - Estado: ${run.status}`);
                workflowStatus[workflowName] = run.status;
                allCompleted = false;
              } else if (run.conclusion !== 'success') {
                console.log(`‚ùå Workflow '${workflowName}' - Conclusi√≥n: ${run.conclusion}`);
                workflowStatus[workflowName] = run.conclusion;
                anyFailed = true;
              } else {
                console.log(`‚úÖ Workflow '${workflowName}' - Pas√≥ exitosamente`);
                workflowStatus[workflowName] = 'success';
              }
            }

            console.log('\nüìä Resumen de estados:');
            console.log(workflowStatus);

            if (anyFailed) {
              console.log('\n‚ùå Algunos workflows fallaron - no se proceder√°');
              core.setFailed('Tests fallaron');
              return;
            }

            if (!allCompleted) {
              console.log('\n‚è≥ Algunos workflows a√∫n no completaron - esperando...');
              console.log('Este workflow se ejecutar√° de nuevo en 5 minutos');
              return;
            }

            console.log('\n‚úÖ ¬°Todos los workflows completaron exitosamente!');
            console.log('Procediendo con el siguiente paso del pipeline...');

      - name: Todos los checks pasaron
        run: echo "‚úÖ Todos los workflows de CI/CD han pasado exitosamente"
