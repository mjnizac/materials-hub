# ----------------------------------------------------------------------------
# Auto Merge Develop to Main Workflow
# This workflow automatically merges develop into main when all CI checks pass.
# It waits for all required workflows to complete successfully before merging.
# ----------------------------------------------------------------------------

name: Auto Merge Develop to Main

on:
  # Trigger after Run Application workflow completes (which is the last to finish)
  workflow_run:
    workflows: ["Run Application"]
    types:
      - completed
    branches:
      - develop

jobs:
  check-and-merge:
    runs-on: ubuntu-24.04
    # Only run if the triggering workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:

      # Step 1: Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: develop

      # Step 2: Wait for all required checks to complete
      - name: Wait for status checks
        uses: actions/github-script@v7
        id: check-status
        with:
          script: |
            const sha = '${{ github.event.workflow_run.head_sha }}';
            console.log(`Checking status for commit: ${sha}`);

            // Wait a bit for other workflows to register
            await new Promise(resolve => setTimeout(resolve, 10000));

            // Get all check runs for this commit
            const { data: checkRuns } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: sha
            });

            console.log(`Found ${checkRuns.check_runs.length} check runs`);

            // Filter for our required workflows
            const requiredWorkflows = ['Pytest', 'Python Lint', 'Run Application'];
            const relevantChecks = checkRuns.check_runs.filter(check =>
              requiredWorkflows.some(workflow => check.name.includes(workflow))
            );

            console.log('Relevant checks:');
            relevantChecks.forEach(check => {
              console.log(`  - ${check.name}: ${check.conclusion}`);
            });

            // Check if all required workflows passed
            const allPassed = relevantChecks.every(check =>
              check.conclusion === 'success'
            );

            if (!allPassed) {
              core.setFailed('Not all required checks passed');
              return false;
            }

            console.log('✅ All required workflows passed!');
            return true;

      # Step 3: Configure Git
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # Step 4: Merge develop into main
      - name: Merge develop to main
        run: |
          git fetch origin main
          git checkout -b main origin/main
          git merge origin/develop --no-ff -m "chore: auto-merge develop to main after successful CI

          ✅ All CI checks passed:
          - Python Lint
          - Pytest
          - Run Application

          Commit: ${{ github.event.workflow_run.head_sha }}"

      # Step 5: Push changes to main
      - name: Push to main
        run: git push origin main
