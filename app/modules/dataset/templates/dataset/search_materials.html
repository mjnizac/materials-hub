{% extends "base_template.html" %}

{% block title %}Search Materials - {{ dataset.ds_meta_data.title }}{% endblock %}

{% block content %}

    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-3">Search Materials</h1>
            <h5 class="text-muted">{{ dataset.ds_meta_data.title }}</h5>
        </div>
    </div>

    <div class="row mt-3">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-body">
                    <form method="GET" action="{{ url_for('dataset.search_materials', dataset_id=dataset.id) }}">
                        <div class="input-group">
                            <input type="text" class="form-control" name="q" placeholder="Search by material name or chemical formula..." value="{{ search_term or '' }}" required>
                            <button class="btn btn-primary" type="submit">
                                <i data-feather="search"></i> Search
                            </button>
                        </div>
                        <div class="form-text">
                            Enter a material name (e.g., "Alumina") or chemical formula (e.g., "Al2O3") to search.
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    {% if search_term %}
        {% if records %}
            <div class="row mt-4">
                <div class="col-12">
                    <div class="alert alert-success" role="alert">
                        <h6 class="alert-heading"><i data-feather="check-circle"></i> Search Results</h6>
                        Found <strong>{{ records|length }}</strong> record{% if records|length != 1 %}s{% endif %} matching "<strong>{{ search_term }}</strong>"
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Search Results</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                    <tr>
                                        <th>Material</th>
                                        <th>Formula</th>
                                        <th>Structure</th>
                                        <th>Property</th>
                                        <th>Value</th>
                                        <th>Unit</th>
                                        <th>Temperature</th>
                                        <th>Data Source</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for record in records %}
                                        <tr>
                                            <td><strong>{{ record.material_name }}</strong></td>
                                            <td>{{ record.chemical_formula or '-' }}</td>
                                            <td>{{ record.structure_type or '-' }}</td>
                                            <td>{{ record.property_name }}</td>
                                            <td>{{ record.property_value }}</td>
                                            <td>{{ record.property_unit or '-' }}</td>
                                            <td>{{ record.temperature or '-' }} {% if record.temperature %}K{% endif %}</td>
                                            <td>
                                                {% if record.data_source %}
                                                    <span class="badge bg-info">{{ record.data_source.value }}</span>
                                                {% else %}
                                                    -
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% if record.description %}
                                        <tr class="table-secondary">
                                            <td colspan="8">
                                                <small><i data-feather="info"></i> <strong>Description:</strong> {{ record.description }}</small>
                                            </td>
                                        </tr>
                                        {% endif %}
                                        {% if record.uncertainty %}
                                        <tr class="table-light">
                                            <td colspan="8">
                                                <small><i data-feather="alert-circle"></i> <strong>Uncertainty:</strong> ± {{ record.uncertainty }}</small>
                                            </td>
                                        </tr>
                                        {% endif %}
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Grouped by Material -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Results Grouped by Material</h5>
                        </div>
                        <div class="card-body">
                            {% set materials = {} %}
                            {% for record in records %}
                                {% if materials.update({record.material_name: materials.get(record.material_name, []) + [record]}) %}{% endif %}
                            {% endfor %}

                            <div class="accordion" id="materialsAccordion">
                                {% for material_name, material_records in materials.items() %}
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="heading{{ loop.index }}">
                                            <button class="accordion-button {% if not loop.first %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}" aria-expanded="{% if loop.first %}true{% else %}false{% endif %}" aria-controls="collapse{{ loop.index }}">
                                                <strong>{{ material_name }}</strong>
                                                <span class="badge bg-primary ms-2">{{ material_records|length }} properties</span>
                                            </button>
                                        </h2>
                                        <div id="collapse{{ loop.index }}" class="accordion-collapse collapse {% if loop.first %}show{% endif %}" aria-labelledby="heading{{ loop.index }}" data-bs-parent="#materialsAccordion">
                                            <div class="accordion-body">
                                                <dl class="row">
                                                    {% if material_records[0].chemical_formula %}
                                                        <dt class="col-sm-3">Chemical Formula</dt>
                                                        <dd class="col-sm-9">{{ material_records[0].chemical_formula }}</dd>
                                                    {% endif %}
                                                    {% if material_records[0].structure_type %}
                                                        <dt class="col-sm-3">Structure Type</dt>
                                                        <dd class="col-sm-9">{{ material_records[0].structure_type }}</dd>
                                                    {% endif %}
                                                    {% if material_records[0].composition_method %}
                                                        <dt class="col-sm-3">Composition Method</dt>
                                                        <dd class="col-sm-9">{{ material_records[0].composition_method }}</dd>
                                                    {% endif %}
                                                </dl>

                                                <h6 class="mt-3">Properties:</h6>
                                                <table class="table table-sm">
                                                    <thead>
                                                    <tr>
                                                        <th>Property</th>
                                                        <th>Value</th>
                                                        <th>Unit</th>
                                                        <th>Temperature</th>
                                                        <th>Source</th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    {% for record in material_records %}
                                                        <tr>
                                                            <td>{{ record.property_name }}</td>
                                                            <td>{{ record.property_value }} {% if record.uncertainty %}± {{ record.uncertainty }}{% endif %}</td>
                                                            <td>{{ record.property_unit or '-' }}</td>
                                                            <td>{{ record.temperature or '-' }} {% if record.temperature %}K{% endif %}</td>
                                                            <td>
                                                                {% if record.data_source %}
                                                                    <span class="badge bg-info">{{ record.data_source.value }}</span>
                                                                {% else %}
                                                                    -
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="row mt-4">
                <div class="col-md-8 offset-md-2">
                    <div class="alert alert-warning" role="alert">
                        <h6 class="alert-heading"><i data-feather="alert-triangle"></i> No Results Found</h6>
                        <p>No materials matching "<strong>{{ search_term }}</strong>" were found in this dataset.</p>
                        <hr>
                        <p class="mb-0">Try searching for:</p>
                        <ul>
                            <li>A different material name</li>
                            <li>A chemical formula (e.g., "Al2O3", "SiO2")</li>
                            <li>A partial name (e.g., "Alumin" instead of "Alumina")</li>
                        </ul>
                    </div>
                </div>
            </div>
        {% endif %}
    {% else %}
        <div class="row mt-4">
            <div class="col-md-8 offset-md-2">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Quick Links</h5>
                    </div>
                    <div class="card-body">
                        <h6>Available Materials in this Dataset:</h6>
                        <div class="d-flex flex-wrap gap-2 mt-3">
                            {% for material in dataset.get_unique_materials()|sort %}
                                <a href="{{ url_for('dataset.search_materials', dataset_id=dataset.id, q=material) }}" class="badge bg-secondary text-decoration-none" style="font-size: 14px; padding: 8px 12px;">
                                    {{ material }}
                                </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <div class="row mt-4">
        <div class="col-12 text-center">
            <a href="{{ url_for('dataset.view_materials_dataset', dataset_id=dataset.id) }}" class="btn btn-primary">
                <i data-feather="eye"></i> View Dataset
            </a>
            <a href="{{ url_for('dataset.materials_dataset_statistics', dataset_id=dataset.id) }}" class="btn btn-info">
                <i data-feather="bar-chart-2"></i> View Statistics
            </a>
            <a href="{{ url_for('dataset.list_materials_datasets') }}" class="btn btn-secondary">
                <i data-feather="arrow-left"></i> Back to List
            </a>
        </div>
    </div>

{% endblock %}
