{% extends "base_template.html" %}

{% block title %}Upload dataset{% endblock %}

{% block content %}

    <h1 class="h2 mb-3"><b>Upload</b> dataset</h1>

    <div class="row">
        <div class="col-12 mb-3">
            <div class="alert alert-warning" role="alert" id="test_zenodo_connection_error" style="display: none">
                <div class="alert-message">

                    <h4 class="alert-heading">
                        <i class="align-middle" data-feather="alert-triangle"></i>
                        Limited connection to the Fakenodo API
                    </h4>
                    <p class="p-0 m-0">
                        There seems to be some kind of problem with the Fakenodo API and synchronization of your
                        dataset metadata may not be possible. We will save your dataset locally to eventually
                        synchronize it with Fakenodo. Sorry for the inconvenience, Fakenodo is an external service
                        and we can't do anything about it.
                    </p>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12 mb-3">
                <div class="alert alert-warning" role="alert" id="use_fakenodo" style="display: none">
                    <div class="alert-message">

                        <h4 class="alert-heading">
                            <i class="align-middle" data-feather="alert-triangle"></i>
                            Fakenodo module is active
                        </h4>
                        <p class="p-0 m-0">
                            The uploaded datasets will be registered in the local server and, when possible,
                            synchronized with Fakenodo to obtain a persistent DOI.
                        </p>
                    </div>
                </div>
            </div>
        </div>

    {% if messages %}
        <ul>
            {% for message in messages %}
                <li>{{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}

    <div class="row">

        <div class="col-xl-6 col-lg-12 col-md-12 col-sm-12">
            <div id="basic_info_form">

                {{ form.hidden_tag() }}

                <div class="row">

                    <div class="col-12">

                        <h1 class="h3 mb-3">Basic info</h1>

                        <div class="row" style="padding-left: 2rem">

                            <div class="col-12">
                                <div class="mb-3">
                                    {{ form.title.label(class="form-label") }} *
                                    {{ form.title(class="form-control") }}
                                    {% for error in form.title.errors %}
                                        <span style="color: red;">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="col-12">
                                <div class="mb-3">
                                    {{ form.desc.label(class="form-label") }} *
                                    {{ form.desc(rows=4, class="form-control") }}
                                    {% for error in form.desc.errors %}
                                        <span style="color: red;">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="col-lg-6 col-6">
                                <div class="mb-3">
                                    {{ form.publication_type.label(class="form-label") }}
                                    {{ form.publication_type(class="form-control") }}
                                </div>

                            </div>

                            <div class="col-lg-6 col-6">
                                <div class="mb-3">
                                    {{ form.publication_doi.label(class="form-label") }}
                                    {{ form.publication_doi(class="form-control") }}
                                    {% for error in form.publication_doi.errors %}
                                        <span style="color: red;">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="col-6">
                                <div class="mb-3">
                                    {{ form.tags.label(class="form-label") }}
                                    {{ form.tags(class="form-control") }}
                                    {% for error in form.tags.errors %}
                                        <span style="color: red;">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                        </div>

                        {# Bloque informativo sobre el DOI del DATASET #}
                        <div class="row" style="padding-left: 2rem">
                            <div class="col-12">
                                <div class="alert alert-info" role="alert">
                                    <h5 class="alert-heading">
                                        <i data-feather="hash"></i>
                                        Dataset DOI in Fakenodo
                                    </h5>
                                    <p class="mb-1">
                                        When you click <strong>"Create Materials Dataset"</strong>, the dataset
                                        metadata will be sent to <strong>Fakenodo</strong>.
                                    </p>
                                    <p class="mb-1">
                                        If the operation succeeds, Fakenodo will create a
                                        <strong>deposition</strong> and assign a <strong>DOI</strong> to your dataset.
                                    </p>
                                    <p class="mb-0">
                                        This dataset DOI will be stored in UVLHub and shown later in the dataset
                                        details page and dataset landing page. You don't need to set it manually here.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <h1 class="h3 mb-3 mt-4">
                          Authors
                          <a href="#" data-toggle="modal" data-target="#infoModal">
                            <i data-feather="info"></i>
                          </a>
                        </h1>

                        <!-- Modal -->
                        <div class="modal fade" id="infoModal" tabindex="-1" role="dialog" aria-labelledby="infoModalLabel" aria-hidden="true" style="display: none">
                          <div class="modal-dialog" role="document">
                            <div class="modal-content">
                              <div class="modal-header">
                                <h5 class="modal-title" id="infoModalLabel">Información Importante</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                  <span aria-hidden="true">&times;</span>
                                </button>
                              </div>
                              <div class="modal-body">
                                ¡Cuidado! Los autores no se pueden editar una vez que el dataset se haya subido a UVLHub.
                                Esta funcionalidad estará disponible para futuras versiones.
                              </div>
                              <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                              </div>
                            </div>
                          </div>
                        </div>

                        <div class="row" style="padding-left: 2rem">

                            <div class="col-lg-6 col-12 mb-3">
                                <label class="form-label">Author name</label>
                                <input class="form-control"
                                       disabled
                                       value="{{ current_user.profile.surname }}, {{ current_user.profile.name }}">
                            </div>

                            <div class="col-lg-6 col-12 mb-3">
                                <label class="form-label">Author affiliation</label>
                                <input class="form-control"
                                       disabled value="{{ current_user.profile.affiliation }}">
                            </div>

                            <div class="col-lg-6 col-12 mb-3">
                                <label class="form-label">Author ORCID</label>
                                <input class="form-control"
                                       disabled value="{{ current_user.profile.orcid }}">
                            </div>

                            <div class="col-12">

                                <div class="mb-3">

                                    <div id="authors">
                                        {% for subform in form.authors %}
                                        <div class="row author" {% if not loop.first %}
                                            style="border:2px dotted #ccc;border-radius:10px;padding:10px;margin:10px 0; background-color: white"
                                            {% endif %}
                                        >
                                            <div class="col-lg-6 col-12 mb-3">
                                                {{ subform.form.name.label(class="form-label") }}
                                                {{ subform.form.name(class="form-control", disabled=loop.first) }}
                                                {% for error in subform.name.errors %}
                                                    <span style="color: red;">{{ error }}</span>
                                                {% endfor %}
                                            </div>

                                            <div class="col-lg-6 col-12 mb-3">
                                                {{ subform.form.affiliation.label(class="form-label") }}
                                                {{ subform.form.affiliation(class="form-control", disabled=loop.first) }}
                                                {% for error in subform.name.errors %}
                                                    <span style="color: red;">{{ error }}</span>
                                                {% endfor %}
                                            </div>

                                            <div class="col-lg-6 col-12 mb-3">
                                                {{ subform.orcid.label(class="form-label") }}
                                                {{ subform.orcid(class="form-control", disabled=loop.first) }}
                                                {% for error in subform.orcid.errors %}
                                                    <span style="color: red;">{{ error }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <button type="button" class="btn btn-secondary" id="add_author">Add author
                                    </button>

                                </div>

                            </div>


                        </div>

                    </div>

                </div>

                <div class="row">

                    {% if error %}

                        <div class="mt-3 col-lg-6 col-12">
                            <span style="color: red;">{{ error }}</span>
                        </div>

                    {% endif %}

                </div>


            </div>
        </div>

        <div class="col-xl-6 col-lg-12 col-md-12 col-sm-12">

            <h1 class="h3 mb-3 mt-2">Materials Dataset Information</h1>

            <div style="padding-left: 2rem">
                <div class="alert alert-info" role="alert">
                    <h5 class="alert-heading"><i data-feather="info"></i> CSV File Upload</h5>
                    <p>After creating your materials dataset, you'll be redirected to upload a CSV file with your materials data.</p>
                    <p>The CSV file should contain the following columns:</p>
                    <ul>
                        <li><strong>Required:</strong> material_name, property_name, property_value</li>
                        <li><strong>Optional:</strong> chemical_formula, structure_type, composition_method, property_unit, temperature, pressure, data_source, uncertainty, description</li>
                    </ul>
                    <p class="mb-0"><strong>Example file:</strong> <code>/examples/materials_example.csv</code></p>
                </div>
            </div>

            <div id="uploaded_models_form" style="display: none; padding-left: 2rem">

                <form action="{{ url_for('dataset.upload') }}" class="dropzone" id="myDropzone">
                    <div id="dropzone-text"></div>
                </form>

                <span class="text-danger" id="alerts" style="display: none">
                    </span>

                <ul class="mt-2" id="file-list"></ul>

                {# Dropzone JS permanece igual #}
                <!-- ... (resto del código Dropzone sin cambios) ... -->

            </div>
        </div>

    </div>

    <div class="row" id="upload_dataset">

        <div class="col-12">

            <hr>

            <h1 class="h3 mb-3 mt-2">Create Materials Dataset</h1>

            <div style="padding-left: 2rem">

                <label class="form-check">
                    <input id="agreeCheckbox" class="form-check-input" type="checkbox" value="">
                    <span class="form-check-label" style="font-size: 15px">
                        I agree to have my materials dataset metadata automatically registered in
                        <strong>Fakenodo</strong> and made available to the public according to the
                        <a href="https://en.wikipedia.org/wiki/Open_science" target="_blank">Open Science</a> manifesto.
                        A persistent <strong>DOI</strong> will be assigned to this dataset by Fakenodo if the
                        registration succeeds.
                    </span>
                </label>

                <button type="button" id="upload_button" class="btn btn-primary mt-2" disabled>
                    <i data-feather="upload" class="center-button-icon"></i>
                    Create Materials Dataset
                </button>

                <div id="loading" style="display: none">
                    <img width="40px" src="{{ url_for("static", filename="gifs/loading.svg") }}"/>
                    Uploading dataset, please wait...
                </div>

                <div class="row">
                    <div class="col-12 mb-3">

                    </div>
                </div>

                <div class="alert alert-error" role="alert" id="upload_error"
                     style="display: none">
                    <div class="alert-message">

                        <h4 class="alert-heading">
                            <i class="align-middle" data-feather="alert-triangle"></i>
                            Limited connection to the Fakenodo API
                        </h4>
                        <p class="p-0 m-0">
                            There seems to be some kind of problem with the Fakenodo API and synchronization of your
                            dataset metadata may not be possible. We will save your dataset locally to eventually
                            synchronize it with Fakenodo. Sorry for the inconvenience, Fakenodo is an external service
                            and we can't do anything about it.
                        </p>
                    </div>
                </div>

                <span class="text-danger mt-2" id="upload_error_text" style="display: none"></span>

                <script>
                    const checkbox = document.getElementById('agreeCheckbox');
                    const upload_button = document.getElementById('upload_button');

                    checkbox.addEventListener('change', function () {
                        upload_button.disabled = !checkbox.checked;
                    });
                </script>

            </div>

        </div>

    </div>

{% endblock %}

{% block scripts %}
    <script src="{{ url_for('dataset.scripts') }}?v={{ range(1, 10000) | random }}"></script>
{% endblock %}
